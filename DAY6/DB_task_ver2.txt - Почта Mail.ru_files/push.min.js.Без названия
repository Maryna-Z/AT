define("left-pad",function(){"use strict";function a(a,b,c){var d="";var e=0;var f;a=a+"";b=parseInt(b,10)||0;c=!c&&c!==0?" ":c+"";if(b>a.length){f=a.length-b;for(e=0;e<b;e++){if(f>=0){d+=a[f]}else{d+=c}f++}}else{d=a}return d}return a});define("left-pad/index",["left-pad"],function(a){return a});define("push-manager",["module","jquery","Emitter","Promise","RPC","left-pad"],function(a,$,b,c,d,e){"use strict";var f=a.config();var g=["push_title","push_body","push_icon","locale","account","application","client_name"];for(var h=0;h<g.length;h++){if(typeof f[g[h]]!=="string"){throw new Error("Module push-manager not configured: "+g[h]+".")}}var i=(new Date).getTimezoneOffset()/60*-1;var j=i>0?"+":"-";var k="GMT"+j+e(Math.abs(i),2,0)+"00";var l={};l.SUBSCRIBE_WAIT=0;l.SUBSCRIBE_NOTAVAIL=1;l.SUBSCRIBE_YES=2;l.SUBSCRIBE_NO=3;l._subscribeStatus=[l.SUBSCRIBE_WAIT];l._subsribtionId=null;l._settingsDefault={state:l.SUBSCRIBE_WAIT,settings:{filterFolders:[],filterTime:"09:00-22:00",clientTZ:k}};l._settings=[$.extend({},l._settingsDefault)];l._accounts=[f.account];l.isSupport=function a(){if(!("serviceWorker"in window.navigator)){return false}if(!("showNotification"in window.ServiceWorkerRegistration.prototype)){return false}if(l.isBlocked()){return false}if(!("PushManager"in window)){return false}try{if(String(window.navigator.userAgent).match(/.*\sGecko\/.*Firefox\/.*/)){return false}}catch(a){}try{if(String(window.navigator.userAgent).match(/.*\sOPR\/\d.*/)){if(!String(window.navigator.userAgent).match(/.*\sMobile\sSafari.*/)){return false}}}catch(a){}return true};var m=$.Deferred();l.register=function a(b,c){if(this.isSupport()){navigator.serviceWorker.register(b,c).then(m.resolve,m.reject)}else{m.reject()}return this.waitRegister()};l.waitRegister=function a(){return m.promise()};l.isPayload=function a(){if(!l.isSupport()){return false}var b;try{b=navigator.userAgent.match(/Chrome\/(\d*)/)}catch(a){}if(b&&b.length&&b[1]){var c=parseInt(b[1],10);if(c>=51){return true}}return false};l.checkStatus=function a(){return new c(function(a,b){if(l.isSupport()){navigator.serviceWorker.ready.then(function(a){return a.pushManager.getSubscription()}).then(function(b){a(!!b)},b)}else{b()}})};l.isBlocked=function a(){if(!window.Notification||window.Notification.permission==="denied"){return true}else{return false}};l._checkSubscribe=function a(){l._subscribeStatus[0]=l.SUBSCRIBE_WAIT;return navigator.serviceWorker.ready.then(function(a){return a.pushManager.getSubscription()}).then(function(a){var b="";if(a){l._subscribeStatus[0]=l.SUBSCRIBE_YES;b=a.subscriptionId||a.endpoint.match(/.*\/(.*)/)[1];l._setSubscriptionId(b)}else{l._subscribeStatus[0]=l.SUBSCRIBE_NO}return l._subscribeStatus[0]},function(){return c.reject(l._subscribeStatus[0]=l.SUBSCRIBE_NOTAVAIL)})};l._setSubscriptionId=function a(b){l._subsribeId=b};l.fetchStatus=function a(b){b=$.extend({reset:false},b);var d;var e=false;for(var f=0;f<this._settings.length;f++){if(this._settings[f].state===l.SUBSCRIBE_WAIT){e=true}}if(!l.isSupport()){d=c.reject(new Error("Push notifications not available"))}else if(!b.reset&&!e){d=c.resolve(l._settings)}else{d=l._checkSubscribe().then(l._fetchSettings)}return d};l.multiAuth=function a(b){for(var c=0;c<b.length;c++){if(this._accounts.indexOf(b[c])==-1){this._accounts.push(b[c]);this._settings.push($.extend({},this._settingsDefault))}}return this._accounts};l.saveSettings=function a(b){var d=$.extend({},this._settings[0].settings),e=$.extend({},this._settings[0].settings,b);var f=e.filterFolders.map(parseFloat);var g=[];for(var h=0;h<f.length;h++){if(g.indexOf(f[h])==-1){g.push(f[h])}}e.filterFolders=g;l._settings[0].settings=e;return l._subscribe().then(function(){return true},function(a){l._settings[0].settings=d;return c.reject(a)})};l._requests=[];l._request=function a(b,e){return new c(function(a,c){if(l._subsribeId){d.post("messages/pushnotifications/settings",{account:b,application:f.application,subscription_id:l._subsribeId,platform:e}).then(function(b){a(b.body)},function(b){if(b.body&&b.body["subscription_id"]&&b.body["subscription_id"].error=="not_exists"){a({})}else{c(b)}})}else{a({})}})};l._fetchSettings=function a(b,d){var e;if(!d){d={}}d.platform=d.platform||(l.isPayload()?"webpush":"android");if(l._requests.length===0){for(var f=0;f<l._accounts.length;f++){var g=l._accounts[f];l._requests.push(l._request(g,d.platform))}}e=c.all.call(this,l._requests).then(function(a){for(var b=0;b<a.length;b++){var c=[],d="";try{c=a[b].settings.capabilities.can_mail.Filter.Folder.filterList}catch(a){}try{d=a[b].settings.capabilities.can_mail.PushDeliveryTimeRange||""}catch(a){}l._settings[b].state=a[b].account?l.SUBSCRIBE_YES:l.SUBSCRIBE_NO;l._settings[b].settings={filterFolders:c,filterTime:d,clientTZ:k}}l._requests=[];return l._settings},function(){l._requests=[];return c.reject("Get settings error")});return e.then(function(a){return l._settings})};l.toggleSubscribe=function a(b){return l.fetchStatus().then(function(a){var b=a[0].state===l.SUBSCRIBE_YES;return b?l._unsubscribe():l._subscribe()})};l._saveServiceWorkerAccounts=function a(b){var c=[];for(var d=0;d<l._settings.length;d++){if(l._settings[d].state===l.SUBSCRIBE_YES){c.push(l._accounts[d])}}b.active.postMessage(JSON.stringify({type:"pushManagerAccounts",body:c}));return c};l._saveSettings=function a(b){var e=b.subscriptionId||b.endpoint.match(/.*\/(.*)/)[1];var g=[];for(var h=0;h<l._accounts.length;h++){var i=l._accounts[h];if(l._settings[h].state===l.SUBSCRIBE_YES){var j={};var k="android";if(l.isPayload()){try{j=JSON.parse(JSON.stringify(b)).keys}catch(a){}k="webpush"}else{j=undefined}g.push({token:e,platform:k,status:0,account:l._accounts[h],application:f.application,settings:{webpush_keys:j,capabilities:{can_mail:{Filter:{Folder:{filterList:l._settings[h].settings.filterFolders,enabled:true}},PushDeliveryTimeRange:l._settings[h].settings.filterTime},chrome_mode:1},badge:{status:false},ClientTimeZone:l._settings[h].settings.clientTZ,device_id:e,client:{lang:f.locale,name:f.client_name,type:"Smartphone"}}})}}return new c(function(a,b){if(g.length){d.post("messages/pushnotifications/settings/edit",{subscriptions:JSON.stringify(g)}).then(function(b){a(b.body)},b)}else{a()}})};l._subscribe=function a(){return navigator.serviceWorker.ready.then(function(a){return a.pushManager.subscribe({userVisibleOnly:true})}).then(function(a){l._settings[0].state=l.SUBSCRIBE_YES;return l._saveSettings(a).then(function(a){l._subscribeStatus[0]=l.SUBSCRIBE_YES;navigator.serviceWorker.ready.then(function(a){l._saveServiceWorkerAccounts(a)});return a})["catch"](function(a){l._settings[0].state=l.SUBSCRIBE_NO})})};l._unsubscribe=function a(){return navigator.serviceWorker.ready.then(function(a){return a.pushManager.getSubscription()}).then(function(a){l._settings[0].state=l.SUBSCRIBE_NO;l._subscribeStatus[0]=l.SUBSCRIBE_NO;return l._saveSettings(a).then(function(b){return navigator.serviceWorker.ready.then(function(b){var d=l._saveServiceWorkerAccounts(b);return a&&d.length===0?a.unsubscribe():c.resolve()})})}).then(function(){return l._checkSubscribe()})};l._migrateToPushWithPayload=function a(b){l._checkSubscribe().then(function(a){if(!l.isPayload()){b(false);return null}switch(a){case l.SUBSCRIBE_YES:var c=function(a,b){if(a()){b()}else{setTimeout(function(){c(a,b)},100)}};var e=function(){c(function(){return d.setup().baseUrl!="//api.mail.ru/"},function(){l._fetchSettings(undefined,{platform:"android"}).then(function(){l.saveSettings().then(function(){b(true)},function(){b(false)})},function(){b(false)})})};if(typeof __PH!="undefined"&&__PH.loadAccountsList){__PH.loadAccountsList(function(a){var b=[];for(var c=0;c<a.accounts.length;c++){b.push(a.accounts[c].email)}l.multiAuth(b);e()})}else{e()}break;default:b(true);break}})};l._onPostMessage=function a(b){try{var c=JSON.parse(b.data);if(c&&c.type==="needPushManagerMigrate"&&c.body){if(c.body.to===2){l._migrateToPushWithPayload(function(a){var d=JSON.stringify({type:"failPushManagerMigrate",body:{from:c.body.from,to:c.body.to}});if(a){d=JSON.stringify({type:"donePushManagerMigrate",body:{from:c.body.from,to:c.body.to}})}b.source.postMessage(d)})}}}catch(a){}};if(l.isSupport()){navigator.serviceWorker.ready.then(function(a){var b=["push_title","push_title_plural","push_body","push_body_plural","push_icon","locale","application","client_name","counter_push_version","counter_push_click","counter_push_show","push_empty_subject","push_from","push_to"];var c={};for(var d=0;d<b.length;d++){c[b[d]]=f[b[d]]}var e=JSON.stringify({type:"pushManagerConfig",body:c});var g;if(l.isPayload()){g=JSON.stringify({type:"pushManagerMigrate",body:{version:2}})}if(a.active){a.active.postMessage(e);g&&a.active.postMessage(g)}if(a.waiting){a.waiting.postMessage(e);g&&a.waiting.postMessage(g)}if(a.installing){a.installing.addEventListener("statechange",function(a){if(a.target.state==="installed"){a.target.postMessage(e);g&&a.target.postMessage(g)}})}navigator.serviceWorker.addEventListener("message",l._onPostMessage)})}b.apply(l);return l});define("push-manager/push-manager",["push-manager"],function(a){return a});